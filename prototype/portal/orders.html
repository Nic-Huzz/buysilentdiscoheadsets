<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Orders - Customer Portal | Silent Disco Headsets</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/portal.css">
</head>
<body>
    <div class="portal-wrapper">
        <!-- Header -->
        <header class="portal-header">
            <div class="container">
                <a href="../index.html" class="portal-logo">
                    <img src="../images/logo-dark.png" alt="Silent Disco Headsets" onerror="this.style.display='none'">
                    <span>Customer Portal</span>
                </a>

                <nav class="portal-nav">
                    <a href="dashboard.html">Dashboard</a>
                    <a href="orders.html" class="active">My Orders</a>
                    <a href="resources.html">Resources</a>
                </nav>

                <div class="portal-user-menu">
                    <button class="portal-user-btn" id="user-menu-btn">
                        <span id="user-name">Account</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </button>
                    <div class="portal-dropdown" id="user-dropdown">
                        <a href="#">My Profile</a>
                        <hr>
                        <button id="logout-btn">Sign Out</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="portal-main">
            <div class="container">
                <div class="dashboard-header">
                    <h1>My Orders</h1>
                    <p>Track your order status and download invoices</p>
                </div>

                <!-- Orders List -->
                <div id="orders-container">
                    <div class="empty-state" id="no-orders" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
                            <line x1="3" y1="6" x2="21" y2="6"></line>
                            <path d="M16 10a4 4 0 0 1-8 0"></path>
                        </svg>
                        <h3>No orders yet</h3>
                        <p>Your orders will appear here once created by our team. Made a purchase? Please allow 24-48 hours for your order to be added.</p>
                        <a href="../index.html#package-builder" class="btn btn-primary" style="margin-top: 1rem;">View Packages</a>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="portal-footer">
            <div class="container">
                <p>Silent Disco Headsets 2025. Need help? <a href="mailto:huzz@nichuzz.com" style="color: var(--purple-dark);">Contact Support</a></p>
            </div>
        </footer>
    </div>

    <!-- Order Detail Modal -->
    <div class="modal-overlay" id="order-modal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h3>Order Details</h3>
                <button class="modal-close">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body" id="order-detail-content">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-client.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        let currentUserId = null;

        document.addEventListener('DOMContentLoaded', async () => {
            await initProtectedPage({
                requireApproved: true,
                onReady: async (user, profile) => {
                    currentUserId = user.id;
                    setupPortalHeader(profile);
                    setupModalCloseHandlers();
                    await loadOrders(user.id);
                }
            });
        });

        async function loadOrders(userId) {
            try {
                const orders = await DB.orders.getByCustomer(userId);
                renderOrders(orders);
            } catch (error) {
                console.error('Error loading orders:', error);
                Utils.showToast('Error loading orders', 'error');
            }
        }

        function renderOrders(orders) {
            const container = document.getElementById('orders-container');
            const emptyState = document.getElementById('no-orders');

            if (orders.length === 0) {
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            const ordersHtml = orders.map(order => {
                const stageInfo = Utils.getStageInfo(order.current_stage);
                const stageIndex = getStageIndex(order.current_stage);
                const progressWidth = (stageIndex / 3) * 100;

                return `
                    <div class="order-tracker" style="cursor: pointer;" onclick="showOrderDetail('${order.id}')">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
                            <div>
                                <span class="order-number" style="font-size: 1.25rem;">${order.order_number}</span>
                                <span style="color: var(--gray-medium); margin-left: 0.5rem;">
                                    Placed on ${Utils.formatDate(order.created_at)}
                                </span>
                            </div>
                            <span class="order-status ${order.current_stage}">${stageInfo.label}</span>
                        </div>

                        <!-- Visual Tracker -->
                        <div class="tracker-stages">
                            <div class="tracker-progress" style="width: ${progressWidth}%;"></div>

                            <div class="tracker-stage ${stageIndex >= 0 ? 'completed' : ''}">
                                <div class="stage-icon">1</div>
                                <span class="stage-label">Order Received</span>
                            </div>

                            <div class="tracker-stage ${stageIndex >= 1 ? 'completed' : ''}">
                                <div class="stage-icon">2</div>
                                <span class="stage-label">Processing</span>
                            </div>

                            <div class="tracker-stage ${stageIndex >= 2 ? 'completed' : ''}">
                                <div class="stage-icon">3</div>
                                <span class="stage-label">Shipped</span>
                            </div>

                            <div class="tracker-stage ${stageIndex >= 3 ? 'completed delivered' : ''}">
                                <div class="stage-icon">4</div>
                                <span class="stage-label">Delivered</span>
                            </div>
                        </div>

                        <!-- Order Summary -->
                        <div class="order-details" style="margin-top: var(--spacing-md);">
                            <div class="order-detail">
                                <span class="label">Headsets</span>
                                <span class="value">${order.headset_quantity || 0}</span>
                            </div>
                            <div class="order-detail">
                                <span class="label">Transmitters</span>
                                <span class="value">${order.transmitter_quantity || 0}</span>
                            </div>
                            <div class="order-detail">
                                <span class="label">Total</span>
                                <span class="value">${Utils.formatCurrency(order.total_amount)}</span>
                            </div>
                            <div class="order-detail">
                                <span class="label">Invoice</span>
                                <span class="value">${order.invoices && order.invoices.length > 0 ? 'Available' : 'Pending'}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = ordersHtml + `<div id="no-orders" style="display: none;"></div>`;
        }

        function getStageIndex(stage) {
            const stages = ['received', 'processing', 'shipped', 'delivered'];
            return stages.indexOf(stage);
        }

        async function showOrderDetail(orderId) {
            try {
                const order = await DB.orders.getById(orderId);
                const history = await DB.orderHistory.getByOrder(orderId);

                const stageInfo = Utils.getStageInfo(order.current_stage);

                let invoiceHtml = '<p style="color: var(--gray-medium);">Invoice not yet available</p>';
                if (order.invoices && order.invoices.length > 0) {
                    const invoice = order.invoices[0];
                    invoiceHtml = `
                        <button class="btn btn-secondary" onclick="downloadInvoice('${invoice.file_path}', '${invoice.file_name}')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 0.5rem;">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            Download Invoice
                        </button>
                    `;
                }

                let historyHtml = '';
                if (history && history.length > 0) {
                    historyHtml = `
                        <h4 style="margin-top: var(--spacing-md); margin-bottom: var(--spacing-sm);">Order Timeline</h4>
                        <div style="border-left: 2px solid var(--purple-dark); padding-left: 1rem; margin-left: 0.5rem;">
                            ${history.map(h => {
                                const info = Utils.getStageInfo(h.stage);
                                return `
                                    <div style="margin-bottom: 1rem; position: relative;">
                                        <div style="position: absolute; left: -1.5rem; top: 0; width: 10px; height: 10px; background: var(--purple-dark); border-radius: 50%;"></div>
                                        <strong>${info.label}</strong>
                                        <div style="font-size: 0.875rem; color: var(--gray-medium);">${Utils.formatDateTime(h.created_at)}</div>
                                        ${h.notes ? `<div style="font-size: 0.875rem; margin-top: 0.25rem;">${h.notes}</div>` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                }

                const content = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
                        <div>
                            <h2 style="margin-bottom: 0.25rem;">${order.order_number}</h2>
                            <span style="color: var(--gray-medium);">Placed on ${Utils.formatDate(order.created_at)}</span>
                        </div>
                        <span class="order-status ${order.current_stage}" style="font-size: 0.9375rem;">${stageInfo.label}</span>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-sm); margin-bottom: var(--spacing-md);">
                        <div class="dashboard-card">
                            <h4 style="margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--gray-medium);">Items</h4>
                            <p style="margin-bottom: 0.25rem;"><strong>${order.headset_quantity || 0}</strong> Headsets</p>
                            <p style="margin-bottom: 0;"><strong>${order.transmitter_quantity || 0}</strong> Transmitters</p>
                        </div>
                        <div class="dashboard-card">
                            <h4 style="margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--gray-medium);">Total Amount</h4>
                            <p style="font-size: 1.5rem; font-weight: 700; color: var(--purple-dark); margin-bottom: 0;">${Utils.formatCurrency(order.total_amount)}</p>
                        </div>
                    </div>

                    ${order.tracking_number ? `
                        <div class="dashboard-card" style="margin-bottom: var(--spacing-sm);">
                            <h4 style="margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--gray-medium);">Tracking Number</h4>
                            <p style="margin-bottom: 0; font-family: monospace; font-size: 1.125rem;">${order.tracking_number}</p>
                        </div>
                    ` : ''}

                    ${order.shipping_address ? `
                        <div class="dashboard-card" style="margin-bottom: var(--spacing-sm);">
                            <h4 style="margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--gray-medium);">Shipping Address</h4>
                            <p style="margin-bottom: 0; white-space: pre-line;">${order.shipping_address}</p>
                        </div>
                    ` : ''}

                    ${order.notes ? `
                        <div class="dashboard-card" style="margin-bottom: var(--spacing-sm);">
                            <h4 style="margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--gray-medium);">Notes</h4>
                            <p style="margin-bottom: 0;">${order.notes}</p>
                        </div>
                    ` : ''}

                    <div style="margin-top: var(--spacing-md);">
                        <h4 style="margin-bottom: var(--spacing-sm);">Invoice</h4>
                        ${invoiceHtml}
                    </div>

                    ${historyHtml}
                `;

                document.getElementById('order-detail-content').innerHTML = content;
                showModal('order-modal');
            } catch (error) {
                console.error('Error loading order detail:', error);
                Utils.showToast('Error loading order details', 'error');
            }
        }

        async function downloadInvoice(filePath, fileName) {
            try {
                Utils.showLoading();
                const url = await Storage.getSignedUrl('invoices', filePath);
                const link = document.createElement('a');
                link.href = url;
                link.download = fileName;
                link.target = '_blank';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                Utils.hideLoading();
            } catch (error) {
                Utils.hideLoading();
                console.error('Error downloading invoice:', error);
                Utils.showToast('Error downloading invoice', 'error');
            }
        }
    </script>
</body>
</html>
