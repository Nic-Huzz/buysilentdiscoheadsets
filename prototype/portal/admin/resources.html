<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resources - Admin | Silent Disco Headsets</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../css/styles.css">
    <link rel="stylesheet" href="../../css/portal.css">
</head>
<body>
    <!-- Sidebar -->
    <aside class="admin-sidebar">
        <a href="../../index.html" class="portal-logo">
            <span>Admin Portal</span>
        </a>

        <nav class="admin-nav">
            <a href="index.html">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                Dashboard
            </a>
            <a href="customers.html">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle></svg>
                Customers
            </a>
            <a href="orders.html">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path><line x1="3" y1="6" x2="21" y2="6"></line></svg>
                Orders
            </a>
            <a href="resources.html" class="active">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                Resources
            </a>
            <a href="upsells.html">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>
                Upsells
            </a>
        </nav>

        <div style="margin-top: auto; padding-top: 2rem;">
            <a href="../dashboard.html" style="display: flex; align-items: center; gap: 0.5rem; color: rgba(255,255,255,0.5); font-size: 0.875rem;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"></path></svg>
                Back to Portal
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="admin-main">
        <header class="admin-header">
            <div>
                <h1 style="font-size: 1.5rem; margin-bottom: 0;">Resources</h1>
            </div>
            <div style="display: flex; gap: 1rem; align-items: center;">
                <button class="btn btn-primary" onclick="showModal('create-resource-modal')">+ Add Resource</button>
                <div class="portal-user-menu">
                    <button class="portal-user-btn" id="user-menu-btn">
                        <span id="user-name">Admin</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
                    </button>
                    <div class="portal-dropdown" id="user-dropdown">
                        <button id="logout-btn">Sign Out</button>
                    </div>
                </div>
            </div>
        </header>

        <div class="admin-content">
            <!-- Resources Table -->
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Category</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="resources-table">
                    <tr>
                        <td colspan="6" style="text-align: center; color: var(--gray-medium);">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Create Resource Modal -->
    <div class="modal-overlay" id="create-resource-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>Add New Resource</h3>
                <button class="modal-close">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="modal-body">
                <form id="create-resource-form">
                    <div class="form-group">
                        <label for="title">Title *</label>
                        <input type="text" id="title" name="title" required placeholder="Resource title">
                    </div>

                    <div class="form-group">
                        <label for="description">Description</label>
                        <textarea id="description" name="description" rows="2" placeholder="Brief description..."></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="category">Category *</label>
                            <select id="category" name="category" required>
                                <option value="">Select category...</option>
                                <option value="Setup Guides">Setup Guides</option>
                                <option value="Event Planning">Event Planning</option>
                                <option value="Tutorials">Tutorials</option>
                                <option value="Marketing Materials">Marketing Materials</option>
                                <option value="Technical Docs">Technical Docs</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="file_type">Type *</label>
                            <select id="file_type" name="file_type" required>
                                <option value="">Select type...</option>
                                <option value="pdf">PDF Document</option>
                                <option value="video">Video</option>
                                <option value="audio">Audio</option>
                                <option value="link">External Link</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group" id="file-upload-group">
                        <label for="resource_file">Upload File *</label>
                        <div class="file-input-wrapper">
                            <input type="file" id="resource_file" name="resource_file" class="file-input">
                            <label class="file-input-label" for="resource_file">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                                Click to upload file
                            </label>
                        </div>
                        <div id="file-preview" class="file-preview" style="display: none;">
                            <span class="file-name"></span>
                            <button type="button" class="remove-file" onclick="removeFile()">Remove</button>
                        </div>
                    </div>

                    <div class="form-group" id="link-input-group" style="display: none;">
                        <label for="external_link">External URL *</label>
                        <input type="url" id="external_link" name="external_link" placeholder="https://...">
                        <div class="form-hint">For YouTube/Vimeo videos, paste the video URL</div>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="is_active" name="is_active" checked>
                            Active (visible to customers)
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="hideModal('create-resource-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="createResource()">Add Resource</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../../js/supabase-client.js"></script>
    <script src="../../js/auth.js"></script>
    <script>
        let allResources = [];

        document.addEventListener('DOMContentLoaded', async () => {
            await initProtectedPage({
                requireAdmin: true,
                onReady: async (user, profile) => {
                    setupPortalHeader(profile);
                    setupAdminSidebar();
                    setupModalCloseHandlers();
                    setupTypeToggle();
                    setupFileInput();
                    await loadResources();
                }
            });
        });

        function setupTypeToggle() {
            document.getElementById('file_type').addEventListener('change', function() {
                const fileGroup = document.getElementById('file-upload-group');
                const linkGroup = document.getElementById('link-input-group');

                if (this.value === 'link' || this.value === 'video') {
                    fileGroup.style.display = 'none';
                    linkGroup.style.display = 'block';
                } else {
                    fileGroup.style.display = 'block';
                    linkGroup.style.display = 'none';
                }
            });
        }

        function setupFileInput() {
            document.getElementById('resource_file').addEventListener('change', function() {
                const preview = document.getElementById('file-preview');
                if (this.files.length > 0) {
                    preview.querySelector('.file-name').textContent = this.files[0].name;
                    preview.style.display = 'flex';
                } else {
                    preview.style.display = 'none';
                }
            });
        }

        function removeFile() {
            document.getElementById('resource_file').value = '';
            document.getElementById('file-preview').style.display = 'none';
        }

        async function loadResources() {
            try {
                allResources = await DB.resources.getAll();
                renderResources();
            } catch (error) {
                console.error('Error loading resources:', error);
                Utils.showToast('Error loading resources', 'error');
            }
        }

        function renderResources() {
            const tbody = document.getElementById('resources-table');

            if (allResources.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--gray-medium);">No resources yet. Click "Add Resource" to create one.</td></tr>';
                return;
            }

            tbody.innerHTML = allResources.map(r => `
                <tr>
                    <td><strong>${r.title}</strong></td>
                    <td>${r.category}</td>
                    <td style="text-transform: uppercase; font-size: 0.75rem; font-weight: 600;">${r.file_type}</td>
                    <td>
                        <span class="badge ${r.is_active ? 'badge-approved' : 'badge-pending'}">
                            ${r.is_active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td>${Utils.formatDate(r.created_at)}</td>
                    <td>
                        <div class="action-btns">
                            <button class="action-btn edit" title="Toggle Status" onclick="toggleResourceStatus('${r.id}', ${r.is_active})">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                            </button>
                            <button class="action-btn delete" title="Delete" onclick="deleteResource('${r.id}', '${r.file_path}')">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        async function createResource() {
            const form = document.getElementById('create-resource-form');
            const formData = new FormData(form);

            const fileType = formData.get('file_type');
            const title = formData.get('title');
            const category = formData.get('category');

            if (!title || !category || !fileType) {
                Utils.showToast('Please fill in required fields', 'error');
                return;
            }

            try {
                Utils.showLoading();

                let filePath = '';

                if (fileType === 'link' || fileType === 'video') {
                    filePath = document.getElementById('external_link').value;
                    if (!filePath) {
                        Utils.hideLoading();
                        Utils.showToast('Please enter a URL', 'error');
                        return;
                    }
                } else {
                    const file = document.getElementById('resource_file').files[0];
                    if (!file) {
                        Utils.hideLoading();
                        Utils.showToast('Please select a file', 'error');
                        return;
                    }
                    filePath = `${category.toLowerCase().replace(/\s+/g, '-')}/${generateUniqueFilename(file.name)}`;
                    await Storage.upload('resources', filePath, file);
                }

                await DB.resources.create({
                    title: title,
                    description: formData.get('description'),
                    category: category,
                    file_type: fileType,
                    file_path: filePath,
                    is_active: document.getElementById('is_active').checked
                });

                Utils.hideLoading();
                Utils.showToast('Resource added successfully', 'success');
                hideModal('create-resource-modal');
                form.reset();
                removeFile();
                await loadResources();

            } catch (error) {
                Utils.hideLoading();
                console.error('Error creating resource:', error);
                Utils.showToast('Error creating resource: ' + error.message, 'error');
            }
        }

        async function toggleResourceStatus(id, currentStatus) {
            try {
                await DB.resources.update(id, { is_active: !currentStatus });
                Utils.showToast(`Resource ${!currentStatus ? 'activated' : 'deactivated'}`, 'success');
                await loadResources();
            } catch (error) {
                console.error('Error updating resource:', error);
                Utils.showToast('Error updating resource', 'error');
            }
        }

        async function deleteResource(id, filePath) {
            if (!await confirmAction('Are you sure you want to delete this resource?')) {
                return;
            }

            try {
                Utils.showLoading();

                // Delete file from storage if it's not a link
                if (filePath && !filePath.startsWith('http')) {
                    try {
                        await Storage.delete('resources', filePath);
                    } catch (e) {
                        console.log('File may not exist:', e);
                    }
                }

                await DB.resources.delete(id);
                Utils.hideLoading();
                Utils.showToast('Resource deleted successfully', 'success');
                await loadResources();
            } catch (error) {
                Utils.hideLoading();
                console.error('Error deleting resource:', error);
                Utils.showToast('Error deleting resource', 'error');
            }
        }
    </script>
</body>
</html>
